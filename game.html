<!DOCTYPE html>
<html>

<head>
    <title>JS Dungeon Crawler</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script>
        // Auto-Focus Canvas on first key press if not focused
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey || e.altKey) return;
            const cvs = document.getElementById('gameCanvas');
            if (cvs && document.activeElement !== cvs && e.target.tagName !== 'INPUT') {
                cvs.focus();
            }
        });

        // Custom Refresh Handler
        const blockRefresh = (e) => {
            const modal = document.getElementById('custom-refresh-modal');
            const isModalActive = modal && modal.style.display === 'flex';

            if (isModalActive) {
                e.preventDefault();
                e.stopImmediatePropagation();
                if (e.type === 'keydown') {
                    if (e.key === 'r' || e.key === 'R' || e.key === 'Enter') {
                        window.location.reload();
                    } else if (e.key === 'c' || e.key === 'C' || e.key === 'Escape') {
                        modal.style.display = 'none';
                    }
                }
                return;
            }

            if ((e.ctrlKey || e.metaKey) && (e.code === 'KeyR' || e.key === 'r')) {
                e.preventDefault();
                e.stopImmediatePropagation();
                if (e.type === 'keydown') {
                    if (modal) modal.style.display = 'flex';
                }
            }
        };
        window.addEventListener('keydown', blockRefresh, { capture: true });
        window.addEventListener('keyup', blockRefresh, { capture: true });
        window.addEventListener('keypress', blockRefresh, { capture: true });
    </script>
</head>

<body>
    <!-- Custom Refresh Modal -->
    <div id="custom-refresh-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; font-family: monospace;">
        <div style="background: #222; border: 2px solid #555; padding: 20px; text-align: center; color: white;">
            <h2 style="margin-top: 0;">Refresh Game?</h2>
            <p>Are you sure you want to refresh? You will lose unsaved progress.</p>
            <div style="margin-top: 20px;">
                <button onclick="document.getElementById('custom-refresh-modal').style.display='none'"
                    style="padding: 10px 20px; margin-right: 10px; cursor: pointer;">Cancel</button>
                <button onclick="window.location.reload()"
                    style="padding: 10px 20px; background: #e74c3c; color: white; border: none; cursor: pointer;">Refresh</button>
            </div>
        </div>
    </div>
    <!-- ... body content ... -->
    <div id="loading"
        style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 9999; align-items: center; justify-content: center; font-family: monospace; font-size: 24px;">
        LOADING...
    </div>
    <div id="ui" style="display:none;">
        <div id="stats-panel">
            <span id="hp">3</span><br>
            KEYS: <span id="keys">0</span> | <span id="bombs">0</span><br>
            Gun: <span id="gun">--</span><br>
            Ammo: <span id="ammo">--</span><br>
            Room: [<span id="roomName">...</span>]<br>
            <div id="shards-container" style="margin-top: 5px; border-top: 1px solid #444; padding-top: 5px;">
                <span id="red-shards" style="color: #e74c3c;">♦ 0</span> |
                <span id="green-shards" style="color: #2ecc71;">◊ 0</span>
            </div>
        </div>
        <canvas id="minimapCanvas" width="100" height="100"
            style="margin-top: 10px; border: 1px solid #444; background: #000; display: block; pointer-events: none;"></canvas>
    </div>

    <div id="speedy-timer" style="
        position: fixed; top: 16px; left: calc(50% - 260px);
        font-family: 'Orbitron', monospace; font-size: 20px; font-weight: bold;
        color: #3498db; text-shadow: 2px 2px 0 #000; z-index: 1000; display: none;
        pointer-events: none; white-space: nowrap;
    ">
        SPEEDY: <span id="st-val">00.00</span>
    </div>

    <div id="ghost-timer" style="
        position: fixed; top: 46px; left: calc(50% - 260px);
        font-family: 'Orbitron', monospace; font-size: 20px; font-weight: bold;
        color: #e74c3c; text-shadow: 2px 2px 0 #000; z-index: 1000; display: none;
        pointer-events: none; white-space: nowrap;
    ">
        GHOST: <span id="gt-val">00.00</span>
    </div>

    <div id="perfect-count" style="
        position: fixed; top: 16px; left: calc(50% + 160px);
        font-family: 'Orbitron', monospace; font-size: 20px; font-weight: bold;
        color: #9b59b6; text-shadow: 2px 2px 0 #000; z-index: 1000; display: none;
        pointer-events: none; white-space: nowrap;
    ">
        PERFECT: <span id="pc-val">0</span>
    </div>

    <div id="nodamage-count" style="
        position: fixed; top: 46px; left: calc(50% + 160px);
        font-family: 'Orbitron', monospace; font-size: 20px; font-weight: bold;
        color: #e74c3c; text-shadow: 2px 2px 0 #000; z-index: 1000; display: none;
        pointer-events: none; white-space: nowrap;
    ">
        NO DMG: <span id="nd-val">0</span>
    </div>

    <div id="shooter-count" style="
        position: fixed; top: 76px; left: calc(50% + 160px);
        font-family: 'Orbitron', monospace; font-size: 20px; font-weight: bold;
        color: #f39c12; text-shadow: 2px 2px 0 #000; z-index: 1000; display: none;
        pointer-events: none; white-space: nowrap;
    ">
        SHOOTER: <span id="sc-val">0</span>
    </div>

    <div id="timer" style="
        position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
        font-family: 'Orbitron', monospace; font-size: 32px; font-weight: bold;
        color: #f1c40f; text-shadow: 2px 2px 0 #000; z-index: 1000; display: none;
        pointer-events: none; white-space: nowrap;
    ">
        <span id="t-min" style="display:inline-block; width: 50px; text-align:right;">00</span>:<span id="t-sec"
            style="display:inline-block; width: 50px; text-align:center;">00</span>.<span id="t-ms"
            style="display:inline-block; width: 40px; text-align:left; font-size: 0.8em;">00</span>
    </div>

    <div id="debug-panel">
        <div id="debug-editor">
            <select id="debug-select"></select>
        </div>
        <div id="debug-form"></div>
    </div>
    <div id="debug-log"
        style="display:none; position: fixed; bottom: 0; left: 0; width: 100%; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 5px; z-index: 1000; pointer-events: auto;">
    </div>

    <div id="welcome" style="display:none;">
        <h1>Geometry Dash</h1>
        <p>press M to toggle music<br>press any key to start</p>
    </div>
    <div id="perfect">Perfect!</div>
    <div id="overlay">
        <h1 id="overlayTitle">Game Over</h1>
        <p id="stats">Rooms Cleared: 0</p>
        <div class="btn-container">
            <button id="restartBtn" onclick="restartGame()">Restart (R)</button>
            <button id="newRunBtn" onclick="newRun()">New Run (N)</button>
            <button id="menuBtn" onclick="goToWelcome()">Main Menu (M)</button>
            <button id="continueBtn" onclick="goContinue()" style="display:none;">Continue (Enter)</button>
        </div>
    </div>

    <div id="newGameModal"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; z-index: 2000;">
        <h1
            style="color: #c0392b; font-family: 'Courier New', monospace; text-shadow: 2px 2px #000; margin-bottom: 20px;">
            START NEW GAME?</h1>
        <p
            style="color: #ecf0f1; font-family: monospace; text-align: center; max-width: 400px; line-height: 1.5; margin-bottom: 30px;">
            WARNING:<br>This will <span style="color: #e74c3c;">DELETE ALL UNLOCKS</span> and progress.<br>Are you sure?
        </p>
        <div class="btn-container" style="gap: 20px;">
            <button onclick="confirmNewGame()"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #c0392b; color: white; border: 2px solid #e74c3c; font-family: monospace;">(D)
                DELETE</button>
            <button onclick="cancelNewGame()"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #666; color: white; border: 2px solid #888; font-family: monospace;">
                CONTINUE (ENTER)</button>
        </div>
    </div>

    <!-- Piggy Bank / ATM Modal -->
    <div id="bankModal"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; z-index: 2000;">
        <h1
            style="color: #2ecc71; font-family: 'Courier New', monospace; text-shadow: 2px 2px #000; margin-bottom: 20px;">
            crytposkillz bank</h1>
        <p
            style="color: #ecf0f1; font-family: monospace; text-align: center; max-width: 400px; line-height: 1.5; margin-bottom: 20px; font-size: 18px;">
            Inventory: <span id="bankInvVal" style="color: #2ecc71;">0</span><br>
            Vault: <span id="bankVaultVal" style="color: #fdcb6e;">0</span><br>
            <span id="bankMessage"></span>
        </p>

        <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <label for="bankAmount" style="color: white; font-family: monospace; font-size: 18px;">Amount:</label>
            <input type="number" id="bankAmount" min="1" value="1"
                style="padding: 10px; font-size: 18px; width: 100px; text-align: center; background: #333; color: white; border: 2px solid #555; font-family: monospace; outline: none;">
            <button
                onclick="document.getElementById('bankAmount').value = document.getElementById('bankInvVal').innerText"
                style="padding: 10px; font-size: 14px; cursor: pointer; background: #2ecc71; color: white; border: none; font-family: monospace;">MAX</button>
            <button
                onclick="document.getElementById('bankAmount').value = document.getElementById('bankVaultVal').innerText"
                style="padding: 10px; font-size: 14px; cursor: pointer; background: #fdcb6e; color: black; border: none; font-family: monospace;">MAX</button>
        </div>

        <div class="btn-container" style="gap: 20px;">
            <button onclick="bankDeposit(document.getElementById('bankAmount').value)"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #27ae60; color: white; border: 2px solid #2ecc71; font-family: monospace;">(D)
                DEPOSIT</button>
            <button onclick="bankWithdraw(document.getElementById('bankAmount').value)"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #f39c12; color: white; border: 2px solid #fdcb6e; font-family: monospace;">(W)
                WITHDRAW</button>
            <button onclick="bankClose()"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #666; color: white; border: 2px solid #888; font-family: monospace;">(ESC)
                CLOSE</button>
        </div>
    </div>

    <!-- Portal Warning Modal -->
    <div id="portalWarningModal"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; z-index: 2000;">
        <h1
            style="color: #f1c40f; font-family: 'Courier New', monospace; text-shadow: 2px 2px #000; margin-bottom: 20px;">
            PORTAL WARNING</h1>
        <p
            style="color: #ecf0f1; font-family: monospace; text-align: center; max-width: 400px; line-height: 1.5; margin-bottom: 30px;">
            There are items remaining in this room!<br><br>
            If you proceed, remaining items will be converted to <span id="portalWarningShardsCount"
                style="color: #e74c3c; font-weight:bold;">0</span> bonus Red Shards.<br>
            Are you sure you want to enter the portal?
        </p>
        <div class="btn-container" style="gap: 20px;">
            <button onclick="confirmPortalTransition()"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #27ae60; color: white; border: 2px solid #2ecc71; font-family: monospace;">
                PROCEED (ENTER)</button>
            <button onclick="cancelPortalTransition()"
                style="padding: 10px 20px; font-size: 18px; cursor: pointer; background: #666; color: white; border: 2px solid #888; font-family: monospace;">
                CANCEL (ESC)</button>
        </div>
    </div>

    <canvas id="gameCanvas" width="600" height="400" tabindex="0" style="outline: none;"></canvas>
    <script type="module" src="assets/js/main.js"></script>

</body>

</html>